import{E as Q,u as X,r as l,j as e}from"./index-CoLLSTFM.js";const c=[];for(let s=0;s<256;++s)c.push((s+256).toString(16).slice(1));function Y(s,r=0){return(c[s[r+0]]+c[s[r+1]]+c[s[r+2]]+c[s[r+3]]+"-"+c[s[r+4]]+c[s[r+5]]+"-"+c[s[r+6]]+c[s[r+7]]+"-"+c[s[r+8]]+c[s[r+9]]+"-"+c[s[r+10]]+c[s[r+11]]+c[s[r+12]]+c[s[r+13]]+c[s[r+14]]+c[s[r+15]]).toLowerCase()}let E;const K=new Uint8Array(16);function Z(){if(!E){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");E=crypto.getRandomValues.bind(crypto)}return E(K)}const _=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),R={randomUUID:_};function ee(s,r,p){var u;if(R.randomUUID&&!s)return R.randomUUID();s=s||{};const d=s.random??((u=s.rng)==null?void 0:u.call(s))??Z();if(d.length<16)throw new Error("Random bytes length must be >= 16");return d[6]=d[6]&15|64,d[8]=d[8]&63|128,Y(d)}const se=()=>{const s=Q(),{showNotification:r}=X(),[p,d]=l.useState([]),[u,V]=l.useState(""),[F,N]=l.useState([]),[O,I]=l.useState(!0),[T,$]=l.useState(null),[m,b]=l.useState([]),[g,z]=l.useState(0),[x,q]=l.useState("cash"),[h,y]=l.useState(""),[f,j]=l.useState(0),[w,v]=l.useState(""),[A,C]=l.useState(!1),[S,D]=l.useState(!1),[B,L]=l.useState(!1),P=l.useCallback(async()=>{try{I(!0),$(null);const t=new Date,a=new Date(t.getFullYear()-1,0,1).toISOString().split("T")[0],n=t.toISOString().split("T")[0],o=await fetch(`/api/products?from=${a}&to=${n}`);if(!o.ok)throw new Error(`Error al cargar productos: ${o.status} ${o.statusText}`);const M=(await o.json()).map(k=>({...k,id:k.id||ee(),price:parseFloat(k.price)||0}));d(M),N(M)}catch(t){console.error("Error al cargar productos:",t),$(t.message||"Error desconocido al cargar productos")}finally{I(!1)}},[]);l.useEffect(()=>{P()},[P]),l.useEffect(()=>{if(!u.trim()){N(p);return}const t=u.toLowerCase(),a=p.filter(n=>{var o,i;return((o=n.name)==null?void 0:o.toLowerCase().includes(t))||((i=n.category)==null?void 0:i.toLowerCase().includes(t))});N(a)},[u,p]),l.useEffect(()=>{const t=m.reduce((a,n)=>{const o=parseFloat(n.price)||0,i=parseInt(n.quantity)||0;return a+o*i},0);z(t),m.length===0&&(y(""),j(0))},[m]);const H=t=>{if(!t||!t.id){console.error("Producto inválido:",t);return}b(a=>a.find(o=>o.id===t.id)?a.map(o=>o.id===t.id?{...o,quantity:(parseInt(o.quantity)||0)+1}:o):[...a,{...t,quantity:1}])},W=t=>{b(a=>a.filter(n=>n.id!==t))},U=(t,a)=>{const n=parseInt(a);isNaN(n)||n<1||b(o=>o.map(i=>i.id===t?{...i,quantity:n}:i))},G=t=>{const a=t.replace(/[^\d.]/g,""),n=parseFloat(a);isNaN(n)?(y(a),j(0)):(y(a),j(n-g))},J=async()=>{if(m.length!==0)try{D(!0);const t={items:m.map(a=>({name:a.name||"Producto sin nombre",category:a.category||"Sin categoría",price:parseFloat(a.price)||0,quantity:parseInt(a.quantity)||1})),total:g,paymentMethod:x,cashReceived:x==="cash"&&parseFloat(h)||0,change:x==="cash"?f:0,customerName:w.trim()||"Cliente General",date:new Date().toISOString()};try{const a=await fetch("/api/sales",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),n=await a.json();if(!a.ok)throw new Error(n.error||"Error al procesar el pago");console.log("Venta procesada exitosamente:",n),r("Venta completada con éxito","success"),L(!0),setTimeout(()=>{b([]),v(""),y(""),j(0),C(!1),L(!1)},2e3)}catch(a){throw console.error("Error al comunicarse con el API:",a),r(`Error al procesar la venta: ${a.message}`,"error"),a}}catch(t){console.error("Error general al procesar el pago:",t),r(`Error: ${t.message}`,"error")}finally{D(!1)}};return e.jsx("div",{className:"flex-1 overflow-auto relative z-10",children:e.jsxs("main",{className:"max-w-7xl mx-auto py-6 px-4 lg:px-8 xl:px-12",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Punto de Venta"}),e.jsx("button",{onClick:()=>s("/"),className:"bg-gray-600 text-white px-4 py-2 rounded",children:"Volver"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[e.jsxs("div",{className:"md:w-2/3 bg-gray-800 p-4 rounded-lg",children:[e.jsx("div",{className:"mb-4",children:e.jsx("input",{type:"text",placeholder:"Buscar productos...",value:u,onChange:t=>V(t.target.value),className:"w-full p-2 bg-gray-700 text-white rounded border border-gray-600"})}),O?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-400",children:"Cargando productos..."})]}):T?e.jsxs("div",{className:"text-center py-8 bg-red-900 bg-opacity-50 rounded-lg p-4",children:[e.jsx("p",{className:"text-white mb-2",children:T}),e.jsx("button",{onClick:P,className:"bg-red-700 text-white px-4 py-2 rounded hover:bg-red-600 transition-colors",children:"Reintentar"})]}):e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:F.length>0?F.map(t=>e.jsxs("div",{className:"bg-gray-700 p-3 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors",onClick:()=>H(t),children:[e.jsx("h3",{className:"font-medium text-white truncate",children:t.name||"Producto sin nombre"}),e.jsx("p",{className:"text-sm text-gray-300",children:t.category||"Sin categoría"}),e.jsxs("p",{className:"text-blue-400 font-bold mt-2",children:["$",(t.price||0).toFixed(2)]})]},t.id)):e.jsx("div",{className:"col-span-full text-center py-4 text-gray-400",children:"No se encontraron productos."})})]}),e.jsxs("div",{className:"md:w-1/3 bg-gray-800 p-4 rounded-lg",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Carrito de Compra"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:"Nombre del Cliente:"}),e.jsx("input",{type:"text",value:w,onChange:t=>v(t.target.value),placeholder:"Opcional",className:"w-full p-2 bg-gray-700 text-white rounded border border-gray-600"})]}),m.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-12 w-12 mx-auto mb-2 text-gray-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"})}),e.jsx("p",{children:"El carrito está vacío."})]}):e.jsxs(e.Fragment,{children:[e.jsx("ul",{className:"space-y-2 mb-4 max-h-80 overflow-y-auto",children:m.map(t=>e.jsxs("li",{className:"flex justify-between items-center bg-gray-700 p-2 rounded",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-white",children:t.name}),e.jsxs("p",{className:"text-sm text-gray-300",children:["$",(t.price||0).toFixed(2)," x ",t.quantity]}),e.jsxs("p",{className:"text-sm text-blue-300",children:["Subtotal: $",((t.price||0)*(t.quantity||0)).toFixed(2)]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{onClick:()=>U(t.id,(t.quantity||0)-1),className:"bg-gray-600 text-white px-2 py-1 rounded mr-1",children:"-"}),e.jsx("span",{className:"mx-1 text-white",children:t.quantity}),e.jsx("button",{onClick:()=>U(t.id,(t.quantity||0)+1),className:"bg-gray-600 text-white px-2 py-1 rounded mr-1",children:"+"}),e.jsx("button",{onClick:()=>W(t.id),className:"bg-red-600 text-white px-2 py-1 rounded",children:"X"})]})]},t.id))}),e.jsx("div",{className:"border-t border-gray-700 pt-4 mb-4",children:e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{children:["$",g.toFixed(2)]})]})}),e.jsx("button",{onClick:()=>C(!0),className:"w-full bg-blue-600 text-white py-2 rounded font-medium hover:bg-blue-700 transition-colors",children:"Procesar Pago"})]})]})]}),A&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50",children:e.jsx("div",{className:"bg-gray-800 p-6 rounded-lg max-w-md w-full",children:B?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx("svg",{className:"w-8 h-8 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M5 13l4 4L19 7"})})}),e.jsx("h3",{className:"text-xl font-bold mb-2 text-white",children:"¡Pago Completado!"}),e.jsx("p",{className:"text-gray-300",children:"La venta se ha registrado exitosamente."})]}):e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-xl font-bold mb-4 text-white",children:"Procesar Pago"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-1",children:"Cliente:"}),e.jsx("input",{type:"text",value:w,onChange:t=>v(t.target.value),placeholder:"Ingrese nombre del cliente",className:"w-full p-2 bg-gray-700 text-white rounded border border-gray-600"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"font-medium mb-2 text-white",children:"Método de pago"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>q("cash"),className:`p-2 rounded ${x==="cash"?"bg-blue-600 text-white":"bg-gray-700 text-gray-300"}`,children:"Efectivo"}),e.jsx("button",{onClick:()=>q("card"),className:`p-2 rounded ${x==="card"?"bg-blue-600 text-white":"bg-gray-700 text-gray-300"}`,children:"Tarjeta"})]})]}),x==="cash"&&e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"font-medium mb-2 text-white",children:"Efectivo recibido"}),e.jsx("input",{type:"text",value:h,onChange:t=>G(t.target.value),placeholder:"Ingrese monto recibido",className:"w-full p-2 bg-gray-700 text-white rounded border border-gray-600"}),h&&e.jsxs("div",{className:"mt-2 flex justify-between",children:[e.jsx("span",{className:"text-gray-300",children:"Cambio:"}),e.jsxs("span",{className:f>=0?"text-green-400":"text-red-400",children:["$",f.toFixed(2)]})]})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold mb-4",children:[e.jsx("span",{className:"text-white",children:"Total:"}),e.jsxs("span",{className:"text-blue-400",children:["$",g.toFixed(2)]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>C(!1),className:"flex-1 bg-gray-700 text-white py-2 rounded",children:"Cancelar"}),e.jsx("button",{onClick:J,disabled:S||x==="cash"&&(parseFloat(h)<g||!h),className:`flex-1 py-2 rounded ${S||x==="cash"&&(parseFloat(h)<g||!h)?"bg-gray-600 opacity-50 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700 text-white"}`,children:S?"Procesando...":"Completar Pago"})]})]})})})]})})};export{se as default};
